<!DOCTYPE html>  <html> <head>   <title>trial.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="core.html">                 core.coffee               </a>                                           <a class="source" href="infra.html">                 infra.coffee               </a>                                           <a class="source" href="user.html">                 user.coffee               </a>                                           <a class="source" href="common.html">                 common.coffee               </a>                                           <a class="source" href="dashboard.html">                 dashboard.coffee               </a>                                           <a class="source" href="events.html">                 events.coffee               </a>                                           <a class="source" href="explore.html">                 explore.coffee               </a>                                           <a class="source" href="home.html">                 home.coffee               </a>                                           <a class="source" href="journal.html">                 journal.coffee               </a>                                           <a class="source" href="old-explore.html">                 old-explore.coffee               </a>                                           <a class="source" href="scheduling.html">                 scheduling.coffee               </a>                                           <a class="source" href="settings.html">                 settings.coffee               </a>                                           <a class="source" href="social.html">                 social.coffee               </a>                                           <a class="source" href="timeline.html">                 timeline.coffee               </a>                                           <a class="source" href="trial.html">                 trial.coffee               </a>                                           <a class="source" href="widgets.html">                 widgets.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               trial.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;models/infra&#39;</span><span class="p">,</span> <span class="s1">&#39;models/core&#39;</span><span class="p">,</span> <span class="s1">&#39;views/widgets&#39;</span><span class="p">,</span> <span class="s1">&#39;QIchart&#39;</span><span class="p">,</span> <span class="s1">&#39;use!D3time&#39;</span><span class="p">,</span> <span class="s1">&#39;use!BackboneFormsBS&#39;</span><span class="p">,</span> <span class="s1">&#39;use!BackboneFormsEditors&#39;</span><span class="p">,</span> <span class="s1">&#39;use!jQueryDatePicker&#39;</span> <span class="p">],</span>
  <span class="nf">(Infra, Core, Widgets, QIChart) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Control chart with dynamic loading</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">ControlChart</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span>
      <span class="nv">attributes:</span>
        <span class="nv">id: </span><span class="s1">&#39;control1&#39;</span>

      <span class="nv">initialize: </span><span class="nf">(options) -&gt;</span>
        <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">not</span> <span class="s1">&#39;trial&#39;</span>
          <span class="nx">alert</span> <span class="s1">&#39;Control chart init error&#39;</span>
        <span class="nv">start = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">subtract</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="nv">end = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;days&#39;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="nx">@fetchData</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span>
        <span class="vi">@cfg =</span>
          <span class="nv">w: </span><span class="mi">800</span>
          <span class="nv">h: </span><span class="mi">200</span>
          <span class="nv">render:</span>
            <span class="nv">xaxis: </span><span class="kc">true</span>
            <span class="nv">yaxis: </span><span class="kc">true</span>
            <span class="nv">series: </span><span class="kc">true</span>
            <span class="nv">path: </span><span class="kc">true</span>
            <span class="nv">meanOffsets: </span><span class="kc">false</span>
          <span class="nv">defaults:</span>
            <span class="nv">glyph: </span><span class="s2">&quot;glyph&quot;</span>
            <span class="nv">pointClass: </span><span class="s2">&quot;point&quot;</span>
            <span class="nv">timeaxis: </span><span class="s2">&quot;rule&quot;</span>
          <span class="nv">title: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">experiment</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
          <span class="nv">margin: </span><span class="mi">20</span>
        <span class="err">@</span>

      <span class="nv">fetchData: </span><span class="nf">(start, end) -&gt;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span> <span class="s1">&#39;/api/charts/trial&#39;</span><span class="p">,</span>
          <span class="nv">data:</span>
            <span class="nv">id: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">id</span>
            <span class="nv">start: </span><span class="nx">start</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;YYYYMMDDTHHmmss.000Z&#39;</span><span class="p">)</span>
            <span class="nv">end: </span><span class="nx">end</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;YYYYMMDDTHHmmss.000Z&#39;</span><span class="p">)</span>
          <span class="nv">context: </span><span class="err">@</span>
          <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">data</span><span class="o">?</span> <span class="o">and</span> <span class="nx">data</span><span class="p">.</span><span class="nx">series</span><span class="o">?</span>
               <span class="nx">@renderChart</span> <span class="nx">data</span>
          <span class="nv">spinner: </span><span class="kc">false</span>

      <span class="nv">redraw: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#control1&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nx">@renderChart</span> <span class="nx">@data</span> <span class="k">if</span> <span class="nx">@data</span><span class="o">?</span>

      <span class="nv">renderChart: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">ready = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#control1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">data</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">ready</span><span class="p">)</span>
           <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">@renderChart</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">data</span>
        <span class="k">else</span>
           <span class="vi">@data = </span><span class="nx">data</span>
           <span class="nx">QIChart</span><span class="p">.</span><span class="nx">renderChart</span> <span class="s1">&#39;#control1&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">@cfg</span>

      <span class="nv">render: </span><span class="o">-&gt;</span>
        <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <hr />

<h2>Trial Summary Pane</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">TrialPane</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span>
      <span class="nv">attributes:</span>
        <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;trial-pane&#39;</span>

      <span class="nv">initialize: </span><span class="nf">(options) -&gt;</span>
          <span class="vi">@template = </span><span class="nx">Infra</span><span class="p">.</span><span class="nx">templateLoader</span><span class="p">.</span><span class="nx">getTemplate</span> <span class="s1">&#39;trial-view-header&#39;</span>
          <span class="vi">@chart = </span><span class="k">new</span> <span class="nx">ControlChart</span>
            <span class="nv">model: </span><span class="nx">@model</span>
          <span class="nx">@model</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@render</span><span class="p">,</span> <span class="err">@</span>
          <span class="nx">@model</span><span class="p">.</span><span class="nx">experiment</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@render</span><span class="p">,</span> <span class="err">@</span>
          <span class="err">@</span>

      <span class="nv">update: </span><span class="o">-&gt;</span>
          <span class="nx">@chart</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span> <span class="nx">@template</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">toTemplateJSON</span><span class="p">()</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@chart</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
          <span class="nx">@chart</span><span class="p">.</span><span class="nx">redraw</span><span class="p">()</span>
          <span class="nx">@trigger</span> <span class="s1">&#39;update&#39;</span>
          <span class="err">@</span>

      <span class="nv">render: </span><span class="o">-&gt;</span>
          <span class="nx">@delegateEvents</span><span class="p">()</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span> <span class="nx">@template</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">toTemplateJSON</span><span class="p">()</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@chart</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
          <span class="nx">@trigger</span> <span class="s1">&#39;update&#39;</span>
          <span class="err">@</span>

      <span class="nv">events:</span>
          <span class="s1">&#39;click .pause&#39;</span><span class="o">:</span> <span class="s1">&#39;pause&#39;</span>
          <span class="s1">&#39;click .resume&#39;</span><span class="o">:</span> <span class="s1">&#39;resume&#39;</span>
          <span class="s1">&#39;click .cancel&#39;</span><span class="o">:</span> <span class="s1">&#39;cancel&#39;</span>
          <span class="s1">&#39;click .archive&#39;</span><span class="o">:</span> <span class="s1">&#39;archive&#39;</span>

      <span class="nv">notify: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">e</span>

      <span class="nv">pause: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="nv">status = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">status</span> <span class="o">is</span> <span class="s1">&#39;active&#39;</span>
             <span class="nx">@model</span><span class="p">.</span><span class="nx">save</span>
                <span class="nv">status: </span><span class="s1">&#39;paused&#39;</span>
          <span class="k">else</span>
             <span class="nx">alert</span> <span class="s1">&#39;Error in trial handling, contact administrator&#39;</span>

      <span class="nv">resume: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="nv">status = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">status</span> <span class="o">is</span> <span class="s1">&#39;paused&#39;</span>
             <span class="nx">@model</span><span class="p">.</span><span class="nx">save</span>
                <span class="nv">status: </span><span class="s1">&#39;active&#39;</span>
          <span class="k">else</span>
             <span class="nx">alert</span> <span class="s1">&#39;Error in trial handling, contact administrator&#39;</span>


      <span class="nv">cancel: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>start abandoned flow</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">archive: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>If not completed, complete</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">complete: </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Completion flow</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <hr />

<h2>Trial Wrapper Frame</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">TrialFrame</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span>
      <span class="nv">attributes:</span>
        <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;trial-frame&#39;</span>

      <span class="nv">initialize: </span><span class="nf">(options) -&gt;</span>
        <span class="vi">@template = </span><span class="nx">Infra</span><span class="p">.</span><span class="nx">templateLoader</span><span class="p">.</span><span class="nx">getTemplate</span> <span class="s1">&#39;trial-view-frame&#39;</span>
        <span class="nx">@collection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;reset add remove&#39;</span><span class="p">,</span> <span class="nx">@configureViews</span><span class="p">,</span> <span class="err">@</span>
        <span class="nx">@configureViews</span><span class="p">()</span>
        <span class="err">@</span>

      <span class="nv">configureViews: </span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">@views</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@views</span><span class="p">,</span> <span class="nf">(view) -&gt;</span> <span class="nx">view</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
        <span class="vi">@views = </span><span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@newTrial</span><span class="p">,</span> <span class="err">@</span>
        <span class="vi">@currentTrial = </span><span class="mi">0</span>
        <span class="nx">@render</span><span class="p">()</span>
        <span class="err">@</span>

      <span class="nv">newTrial: </span><span class="nf">(trial) -&gt;</span>
        <span class="nv">trial = </span><span class="k">new</span> <span class="nx">TrialPane</span>
          <span class="nv">model: </span><span class="nx">trial</span>
        <span class="nx">trial</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">@updateTrialHeader</span><span class="p">,</span> <span class="err">@</span>
        <span class="nx">trial</span>

      <span class="nv">render: </span><span class="o">-&gt;</span>
        <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span> <span class="nx">@template</span>
           <span class="nv">empty: </span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@views</span>
        <span class="nx">@renderTrial</span><span class="p">()</span>

      <span class="nv">renderTrial: </span><span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@views</span><span class="p">[</span><span class="nx">@currentTrial</span><span class="p">]</span><span class="o">?</span>
          <span class="nx">@$</span><span class="p">(</span><span class="s1">&#39;#trial-pane-wrapper&#39;</span><span class="p">).</span><span class="nx">html</span> <span class="nx">@views</span><span class="p">[</span><span class="nx">@currentTrial</span><span class="p">].</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
        <span class="err">@</span>

      <span class="nv">updateTrialHeader: </span><span class="o">=&gt;</span>
        <span class="nx">@$</span><span class="p">(</span><span class="s1">&#39;.trial-title-bar .button&#39;</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;disabled&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">@currentTrial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="nx">@views</span><span class="p">.</span><span class="nx">length</span>
          <span class="nx">@$</span><span class="p">(</span><span class="s1">&#39;.trial-title-bar .next&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;disabled&#39;</span>
        <span class="k">if</span> <span class="nx">@currentTrial</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">@$</span><span class="p">(</span><span class="s1">&#39;.trial-title-bar .prev&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;disabled&#39;</span>

      <span class="nv">renderInstruments: </span><span class="nf">(experiment) -&gt;</span>
            <span class="nv">mydiv = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;trial-measures&#39;/&gt;&quot;</span><span class="p">)</span>
            <span class="nx">@$el</span><span class="p">.</span><span class="nx">append</span> <span class="nx">mydiv</span>
            <span class="nx">mydiv</span><span class="p">.</span><span class="nx">append</span> <span class="s1">&#39;&lt;h2&gt;Tracking Instruments&lt;/h2&gt;&#39;</span>
            <span class="nv">instruments = </span><span class="nx">experiment</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;instruments&#39;</span><span class="p">)</span>
            <span class="nv">data = </span><span class="p">{</span><span class="nv">instruments: </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">instruments</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toTemplateJSON</span><span class="p">())}</span>
            <span class="nx">mydiv</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@instTableTemplate</span> <span class="nx">data</span>

      <span class="nv">events:</span>
        <span class="s1">&#39;click button.next&#39;</span><span class="o">:</span> <span class="s1">&#39;nextTrial&#39;</span>
        <span class="s1">&#39;click button.prev&#39;</span><span class="o">:</span> <span class="s1">&#39;prevTrial&#39;</span>

      <span class="nv">nextTrial: </span><span class="o">=&gt;</span>
        <span class="vi">@currentTrial = </span><span class="nx">@currentTrial</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nx">@renderTrial</span><span class="p">()</span>

      <span class="nv">prevTrial: </span><span class="o">=&gt;</span>
        <span class="vi">@currentTrial = </span><span class="nx">@currentTrial</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nx">@renderTrial</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>NAMESPACE</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Pane: </span><span class="nx">TrialPane</span>
    <span class="nv">Frame: </span><span class="nx">TrialFrame</span>
    <span class="nv">ControlChart: </span><span class="nx">ControlChart</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 