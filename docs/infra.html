<!DOCTYPE html>  <html> <head>   <title>infra.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="core.html">                 core.coffee               </a>                                           <a class="source" href="infra.html">                 infra.coffee               </a>                                           <a class="source" href="user.html">                 user.coffee               </a>                                           <a class="source" href="common.html">                 common.coffee               </a>                                           <a class="source" href="dashboard.html">                 dashboard.coffee               </a>                                           <a class="source" href="events.html">                 events.coffee               </a>                                           <a class="source" href="explore.html">                 explore.coffee               </a>                                           <a class="source" href="home.html">                 home.coffee               </a>                                           <a class="source" href="journal.html">                 journal.coffee               </a>                                           <a class="source" href="settings.html">                 settings.coffee               </a>                                           <a class="source" href="social.html">                 social.coffee               </a>                                           <a class="source" href="trial.html">                 trial.coffee               </a>                                           <a class="source" href="widgets.html">                 widgets.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               infra.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;use!Backbone&#39;</span><span class="p">],</span>
  <span class="nf">($, Backbone) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <hr />

<h2>Language Extensions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Coffeescript Class Mixins</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_implements = </span><span class="nf">(classes...) -&gt;</span>
        <span class="k">for</span> <span class="nx">klass</span> <span class="k">in</span> <span class="nx">classes</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>static properties</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="nx">prop</span> <span class="k">of</span> <span class="nx">klass</span>
                <span class="err">@</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">klass</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>prototype properties</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="nx">prop</span> <span class="k">of</span> <span class="nx">klass</span><span class="p">.</span><span class="nx">prototype</span>
                    <span class="nv">getter = </span><span class="nx">klass</span><span class="o">::</span><span class="nx">__lookupGetter__</span><span class="p">(</span><span class="nx">prop</span><span class="p">)</span>
                    <span class="nv">setter = </span><span class="nx">klass</span><span class="o">::</span><span class="nx">__lookupSetter__</span><span class="p">(</span><span class="nx">prop</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nx">getter</span> <span class="o">||</span> <span class="nx">setter</span>
                        <span class="err">@</span><span class="o">::</span><span class="nx">__defineGetter__</span><span class="p">(</span><span class="nx">prop</span><span class="p">,</span> <span class="nx">getter</span><span class="p">)</span> <span class="k">if</span> <span class="nx">getter</span>
                        <span class="err">@</span><span class="o">::</span><span class="nx">__defineSetter__</span><span class="p">(</span><span class="nx">prop</span><span class="p">,</span> <span class="nx">setter</span><span class="p">)</span> <span class="k">if</span> <span class="nx">setter</span>
                    <span class="k">else</span>
                        <span class="err">@</span><span class="o">::</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">klass</span><span class="o">::</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Add 'implements' to global function prototype for @implements in class defs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s2">&quot;implements&quot;</span><span class="p">,</span> <span class="nv">value : </span><span class="nx">_implements</span>
    <span class="k">else</span>
        <span class="nb">Function</span><span class="o">::</span><span class="nv">implements = </span><span class="nx">_implements</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <hr />

<h2>Backbone.Embedded Extension</h2>

<ul>
<li>Submodels: manage sub-fields of a document which maintain an
embedding hierarchy</li>
<li>References: a poor-mans Bootstrap.Relational, pass a [type-tag, id]
field which allows you to have a class of objects be stored in a cache.</li>
<li>Global caching of referenced objects</li>
<li>Global server type tag registration for instantiating objects on load.</li>
<li>Lazy loading of references: set id and type and fetch in the background
or batch fetch later (if have API to support).  We can create
singleton referred objects lazily.  For now we background load them.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Save methods we're going to override</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_set = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span>
    <span class="nv">_get = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span>
    <span class="nv">_toJSONModel = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Singleton reference store</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">ReferenceCache</span>
      <span class="nv">constructor: </span><span class="o">-&gt;</span>
           <span class="vi">@lazy = </span><span class="kc">false</span>
           <span class="vi">@types = </span><span class="p">{}</span> <span class="c1"># assoc: types[name] =&gt; constructors</span>
           <span class="vi">@instances = </span><span class="p">{}</span> <span class="c1"># assoc: instances[id] =&gt; model</span>
           <span class="err">@</span>

      <span class="nv">registerTypes: </span><span class="nf">(map) -&gt;</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">@types</span><span class="p">,</span> <span class="nx">map</span><span class="p">)</span>

      <span class="nv">lookupConstructor: </span><span class="nf">(type) -&gt;</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="k">then</span> <span class="nx">@types</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="k">else</span> <span class="nx">type</span>

      <span class="nv">loadAll: </span><span class="nf">() -&gt;</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@instances</span><span class="p">,</span> <span class="nf">(instance, id) -&gt;</span>
            <span class="k">if</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_loaded</span> <span class="o">is</span> <span class="kc">false</span>
               <span class="nx">instance</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span>

      <span class="nv">importFromID: </span><span class="nf">(id, target) -&gt;</span>
          <span class="nv">string = </span><span class="nx">$</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
          <span class="nv">attrs = </span><span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
          <span class="nx">@import</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">target</span> <span class="k">if</span> <span class="nx">attrs</span><span class="o">?</span>

      <span class="nv">import: </span><span class="nf">(data, target) -&gt;</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
             <span class="k">if</span> <span class="nx">target</span><span class="o">?</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;cannot import array to target&#39;</span><span class="p">)</span>
             <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(attrs) -&gt;</span>
                <span class="nx">@import</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">attrs</span><span class="p">,</span><span class="nx">target</span><span class="p">)</span>
             <span class="p">,</span> <span class="err">@</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
             <span class="k">if</span> <span class="nx">target</span><span class="o">?</span>
                <span class="nx">target</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span>
                <span class="nx">target</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span>
                <span class="nx">@register</span> <span class="nx">target</span>
                <span class="nx">target</span><span class="p">.</span><span class="nx">set</span> <span class="nx">data</span>
                <span class="nx">target</span>
             <span class="k">else</span>
                <span class="nv">object = </span><span class="nx">@resolve</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nv">lazy: </span><span class="nx">@lazy</span><span class="p">,</span> <span class="nv">attrs: </span><span class="nx">data</span><span class="p">}</span>
                <span class="nx">object</span><span class="p">.</span><span class="nx">set</span> <span class="nx">data</span>
                <span class="nx">object</span>

      <span class="nv">resolve: </span><span class="nf">(type, id, options = {lazy: @lazy}) -&gt;</span>
          <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">id</span><span class="o">?</span> <span class="o">or</span> <span class="nx">type</span><span class="o">?</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ReferenceCache.resolve requires valid type and id&#39;</span><span class="p">)</span>
          <span class="nv">instance = </span><span class="nx">@instances</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">instance</span><span class="o">?</span>
            <span class="nv">attrs = </span><span class="nx">options</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">or</span> <span class="p">{</span><span class="nv">type: </span><span class="nx">type</span><span class="p">,</span> <span class="nv">id: </span><span class="nx">id</span><span class="p">}</span>
            <span class="nv">instance = </span><span class="k">new</span><span class="p">(</span><span class="nx">@lookupConstructor</span><span class="p">(</span><span class="nx">type</span><span class="p">))(</span><span class="nx">attrs</span><span class="p">)</span>
            <span class="nx">@register</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">options</span>
          <span class="nx">instance</span>

      <span class="nv">register: </span><span class="nf">(instance, options = {lazy: @lazy}) -&gt;</span>
          <span class="k">if</span> <span class="nx">@instances</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot register over an existing object&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Reference state</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">instance._refType = </span><span class="nx">instance</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
          <span class="nv">instance._embedLocation = </span><span class="nf">() -&gt;</span> <span class="kc">null</span>
          <span class="nv">instance._embedParent = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Configure lazy status</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">_loaded</span>
            <span class="nv">instance._loaded = </span><span class="nx">instance</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">complete</span><span class="p">(</span> <span class="o">-&gt;</span>
                <span class="nv">instance._loaded = </span><span class="kc">true</span>
            <span class="p">).</span><span class="nx">fail</span><span class="p">(</span> <span class="o">-&gt;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;failed to load:&#39;</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">instance</span>
            <span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span>
            <span class="nv">instance._loaded = </span><span class="kc">false</span>
            <span class="k">if</span> <span class="nx">@lazy</span> <span class="o">is</span> <span class="o">not</span> <span class="kc">true</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Lazy loading not implemented&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Remove when destroyed</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">instance</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">@unregister</span>
          <span class="nx">@instances</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span>
          <span class="nx">instance</span>

      <span class="nv">unregister: </span><span class="nf">( instance ) -&gt;</span>
          <span class="nx">instance</span><span class="p">.</span><span class="kc">off</span> <span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">@unregister</span>
          <span class="k">delete</span> <span class="nx">@instances</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Create a singleton cache instance to track instances</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Backbone.ReferenceCache = </span><span class="k">new</span> <span class="nx">ReferenceCache</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h1>Add Embedded Model Functionality to Backbone.Model</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Extend Backbone.Model to override parsing</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
      <span class="nv">_loaded = </span><span class="kc">true</span> <span class="c1"># default is explictly managed, or loaded</span>
      <span class="nv">_importers:</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Just return the reference, ok if overwriting</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">reference: </span><span class="nf">(attr,model,conType,ref) -&gt;</span>
              <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">ref</span>
                <span class="p">[</span><span class="nx">servType</span><span class="p">,</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ref</span>
                <span class="nx">Backbone</span><span class="p">.</span><span class="nx">ReferenceCache</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">servType</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nv">lazy: </span><span class="kc">false</span><span class="p">}</span>
              <span class="k">else</span>
                <span class="nx">ref</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>These collections need to be of type RefCollection
so add/del serializes and update the server's array of
references</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">references: </span><span class="nf">(attr, coll, conType, ref_array) -&gt;</span>
              <span class="nx">coll</span> <span class="o">?=</span> <span class="k">new</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">ReferenceCache</span><span class="p">.</span><span class="nx">lookupConstructor</span><span class="p">(</span><span class="nx">conType</span><span class="p">))</span>
              <span class="nx">coll</span><span class="p">.</span><span class="nx">reset</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">ref_array</span><span class="p">,</span> <span class="nf">(ref) -&gt;</span>
                <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">ref</span>
                   <span class="p">[</span><span class="nx">servType</span><span class="p">,</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ref</span>
                   <span class="nx">Backbone</span><span class="p">.</span><span class="nx">ReferenceCache</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">servType</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nv">lazy: </span><span class="kc">false</span><span class="p">}</span>
                <span class="k">else</span>
                   <span class="nx">ref</span>
              <span class="nv">coll._embedParent = </span><span class="err">@</span>
              <span class="nv">coll._embedLocation = </span><span class="nf">() -&gt;</span> <span class="nx">attr</span>
              <span class="nv">coll._referenceCollection = </span><span class="kc">true</span>
              <span class="nx">coll</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Parse into existing or new model if data is provided</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">submodel: </span><span class="nf">(attr, model, type, attrs) -&gt;</span>
              <span class="nx">model</span> <span class="o">?=</span> <span class="k">new</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">ReferenceCache</span><span class="p">.</span><span class="nx">lookupConstructor</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span>
              <span class="k">if</span> <span class="nx">attrs</span> <span class="o">and</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="nx">model</span><span class="p">.</span><span class="nx">set</span> <span class="nx">attrs</span>
              <span class="k">else</span>
                <span class="nx">model</span><span class="p">.</span><span class="nx">clear</span>
                <span class="nv">model._loaded = </span><span class="kc">false</span>
              <span class="nv">model._embedParent = </span><span class="err">@</span>
              <span class="nv">model._embedLocation = </span><span class="nf">() -&gt;</span> <span class="nx">attr</span>
              <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Parse into existing or new collection if data is provided</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">submodels: </span><span class="nf">(attr, coll, type, attrs_array) -&gt;</span>
              <span class="nx">coll</span> <span class="o">?=</span> <span class="k">new</span><span class="p">(</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">ReferenceCache</span><span class="p">.</span><span class="nx">lookupConstructor</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span>
              <span class="nv">coll._embedParent = </span><span class="k">this</span>
              <span class="nv">coll._embedLocation = </span><span class="nf">() -&gt;</span> <span class="nx">attr</span>
              <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">attrs_array</span>
                <span class="nv">importModel = </span><span class="nf">(attrs) -&gt;</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">attrs</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid submodel attributes&#39;</span><span class="p">)</span>
                    <span class="nv">model = </span><span class="k">new</span><span class="p">(</span><span class="nx">coll</span><span class="p">.</span><span class="nx">model</span><span class="p">)</span>
                    <span class="nx">model</span><span class="p">.</span><span class="nx">set</span> <span class="nx">attrs</span>
                    <span class="nv">model._embedParent = </span><span class="nx">coll</span>
                    <span class="nv">model._embedLocation = </span><span class="nf">() -&gt;</span>
                        <span class="k">if</span> <span class="nx">@id</span> <span class="k">then</span> <span class="nx">@id</span> <span class="k">else</span> <span class="kc">null</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot import embedded models without id&#39;</span><span class="p">)</span>
                    <span class="nx">model</span>
                <span class="nx">coll</span><span class="p">.</span><span class="nx">reset</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">attrs_array</span><span class="p">),</span> <span class="nx">importModel</span><span class="p">,</span> <span class="err">@</span>
              <span class="k">else</span>
                <span class="nx">coll</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
                <span class="nv">coll._loaded = </span><span class="kc">false</span>
              <span class="nx">coll</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>New Model Utilities</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Is Lazy Loading in-process or complete? (holds a deferred if loading)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">isLoaded: </span><span class="o">-&gt;</span>
          <span class="nx">@_loaded</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Get the embedding path for this object (sequences of nested models)
returns chained array of objects from root to parent</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">getEmbedPath: </span><span class="nf">() -&gt;</span>
          <span class="k">if</span> <span class="nx">@_embedParent</span> <span class="k">then</span> <span class="nx">@_embedParent</span><span class="p">.</span><span class="nx">getEmbedPath</span><span class="p">().</span><span class="nx">push</span> <span class="err">@</span> <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([</span><span class="err">@</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Return a server-friendly reference for this object
(Only root objects are referencable for now)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">asReference: </span><span class="nf">() -&gt;</span>
          <span class="k">if</span> <span class="nx">@getEmbedPath</span><span class="p">().</span><span class="nx">value</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="err">@</span>
             <span class="p">[</span><span class="nx">@_refType</span><span class="p">,</span> <span class="nx">@id</span><span class="p">]</span>
          <span class="k">else</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot return a reference for an embedded model&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Override default model behavior</h2>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">_setEmbedded: </span><span class="nf">(attr, value) -&gt;</span>
          <span class="p">[</span><span class="nx">importer</span><span class="p">,</span> <span class="nx">conType</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@embedded</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">importer</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Trying to set non-embedded attribute &#39;</span> <span class="o">+</span> <span class="nx">attr</span><span class="p">)</span>
          <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_importers</span><span class="p">[</span><span class="nx">importer</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">attr</span><span class="p">,</span><span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">],</span><span class="nx">conType</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span>
          <span class="err">@</span>

      <span class="nv">set: </span><span class="nf">(attr, value, options) -&gt;</span>
          <span class="vi">@_loaded = </span><span class="kc">true</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">@embedded</span><span class="o">?</span>
             <span class="k">return</span> <span class="nx">_set</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">attr</span>
             <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">attr</span><span class="p">,</span> <span class="nf">(val,key) -&gt;</span>
                <span class="k">if</span> <span class="nx">@embedded</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
                   <span class="nx">@_setEmbedded</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span>
                   <span class="nx">@trigger</span> <span class="s1">&#39;change:&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">,</span> <span class="err">@</span>
                   <span class="k">delete</span> <span class="nx">attr</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
             <span class="p">,</span> <span class="err">@</span>
             <span class="nx">_set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">@embedded</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
             <span class="nx">@_setEmbedded</span> <span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span>
             <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="o">is</span> <span class="kc">true</span>
                <span class="nx">@trigger</span> <span class="s1">&#39;change:&#39;</span><span class="p">,</span> <span class="err">@</span>
                <span class="nx">@trigger</span> <span class="s1">&#39;change&#39;</span> <span class="o">+</span> <span class="nx">attr</span><span class="p">,</span> <span class="err">@</span>
             <span class="err">@</span>
          <span class="k">else</span>
             <span class="nx">_set</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="err">@</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)</span>

      <span class="nv">get: </span><span class="nf">(attr) -&gt;</span>
          <span class="k">if</span> <span class="nx">@embedded</span> <span class="o">and</span> <span class="nx">@embedded</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">and</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
             <span class="k">return</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">@_loaded</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">attr</span> <span class="o">is</span> <span class="s1">&#39;id&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">attr</span> <span class="o">is</span> <span class="s1">&#39;type&#39;</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Object is not loaded&#39;</span><span class="p">)</span>
          <span class="nx">_get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">attr</span><span class="p">)</span>

      <span class="nv">toJSON: </span><span class="nf">(options) -&gt;</span>
          <span class="nv">json = </span><span class="nx">_toJSONModel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@embedded</span><span class="p">,</span> <span class="nf">(record, attr) -&gt;</span>
                 <span class="p">[</span><span class="nx">exporter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span>
                 <span class="k">if</span> <span class="nx">exporter</span> <span class="o">is</span> <span class="s1">&#39;reference&#39;</span> <span class="o">and</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
                    <span class="nx">json</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">].</span><span class="nx">asReference</span><span class="p">()</span>
          <span class="p">,</span> <span class="err">@</span>
          <span class="nx">json</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Extensions to Backbone.Collection for Embedded Models</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">__prepareModel = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_prepareModel</span>
    <span class="nv">_toJSONColl = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Get the embedding path for this object (sequences of nested models),
returns chained array of objects from root to parent</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">getEmbedPath: </span><span class="nf">() -&gt;</span>
          <span class="k">if</span> <span class="nx">@_embedParent</span> <span class="k">then</span> <span class="nx">@_embedParent</span><span class="p">.</span><span class="nx">getEmbedPath</span><span class="p">().</span><span class="nx">push</span> <span class="err">@</span> <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([</span><span class="err">@</span><span class="p">])</span>

      <span class="nv">toJSON: </span><span class="nf">(options) -&gt;</span>
          <span class="k">if</span> <span class="nx">@_referenceCollection</span>
             <span class="nx">@models</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(model) -&gt;</span>
                <span class="nx">model</span><span class="p">.</span><span class="nx">asReference</span><span class="p">()</span>
          <span class="k">else</span>
             <span class="nx">_toJSONColl</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>When adding a model, maintain the parent reference
if we're an embedded collection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">_prepareModel: </span><span class="nf">(model, options) -&gt;</span>
          <span class="nv">model = </span><span class="nx">__prepareModel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">@_embedParent</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">_embedParent</span> <span class="o">?=</span> <span class="err">@</span>
            <span class="nv">model._embedLocation = </span><span class="nf">() -&gt;</span>
                <span class="k">if</span> <span class="nx">@id</span> <span class="k">then</span> <span class="nx">@id</span> <span class="k">else</span> <span class="kc">null</span>
          <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2>Template Loader</h2>

<p>Support lazy loading of templates if they aren't all pre-rendered
into the DOM.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">TemplateLoader</span>
      <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
          <span class="vi">@templateUrl = </span><span class="s1">&#39;/api/templates/&#39;</span>
          <span class="vi">@templateCache = </span><span class="p">{}</span>
          <span class="err">@</span>

      <span class="nv">fetchUrl: </span><span class="nf">(id) -&gt;</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">@templateUrl</span>
            <span class="nx">@templateUrl</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">id</span><span class="p">}</span>
          <span class="k">else</span>
            <span class="nx">@templateUrl</span> <span class="o">+</span> <span class="nx">id</span>


      <span class="nv">getTemplate: </span><span class="nf">(id, options = {lazy: false}) -&gt;</span>
          <span class="k">if</span> <span class="nx">@templateCache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
            <span class="nx">@templateCache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nx">@templateCache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nv">deferred = </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
                          <span class="nv">url: </span><span class="nx">@fetchUrl</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                          <span class="nv">async: </span><span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span>
                          <span class="nv">context: </span><span class="err">@</span>
                          <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
                            <span class="nx">@templateCache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">data</span>
            <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lazy</span>
               <span class="nx">deferred</span>
            <span class="k">else</span>
               <span class="nx">@templateCache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>Specific Implementation of Submodel API</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h3>Support for PersonalExperiments backend API</h3>

<p>Assumes Backbone.Embedded</p>

<p>serverType: specify the type tag for the model,
  default to 'type' attribute if it is not present.  Return it
  in JSON requests if not provided</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">class</span> <span class="nx">Model</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Declarations for subclasses</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">getServerType: </span><span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">@serverType</span>
            <span class="nx">@serverType</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">@get</span> <span class="s1">&#39;type&#39;</span>
            <span class="nx">@get</span> <span class="s1">&#39;type&#39;</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No server type provided for Model&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Default submodel URLs</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">url: </span><span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">@_embedParent</span>
            <span class="p">[</span><span class="nx">root</span><span class="p">,</span> <span class="nx">embeds</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">@getEmbedPath</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>
            <span class="nv">locations = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">embeds</span><span class="p">,</span> <span class="nf">(obj) -&gt;</span>
              <span class="nx">obj</span><span class="p">.</span><span class="nx">_embedLocation</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">@isNew</span><span class="p">()</span>
              <span class="s2">&quot;/api/embed/#{ root.getServerType() }/#{ root.id }/#{ _.initial(locations).join(&#39;/&#39;) }&quot;</span>
            <span class="k">else</span>
              <span class="s2">&quot;/api/embed/#{ root.getServerType() }/#{ root.id }/#{ locations.join(&#39;/&#39;) }&quot;</span>
          <span class="k">else</span>
            <span class="s2">&quot;/api/root/#{ @getServerType() }/#{ @id }&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Make sure we always serialize our model type, particularly for new</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">toJSON: </span><span class="nf">(options) -&gt;</span>
          <span class="nv">json = </span><span class="k">super</span> <span class="nx">options</span>
          <span class="nv">json.type = </span><span class="nx">@getServerType</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">json</span><span class="p">.</span><span class="nx">type</span>
          <span class="nx">json</span>

    <span class="k">class</span> <span class="nx">Collection</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span>
      <span class="nv">getServerType: </span><span class="o">-&gt;</span>
          <span class="nx">@model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getServerType</span><span class="p">()</span>

      <span class="nv">url: </span><span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">@_embedParent</span>
            <span class="p">[</span><span class="nx">root</span><span class="p">,</span> <span class="nx">embeds</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">@getEmbedPath</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>
            <span class="nv">locations = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">embeds</span><span class="p">,</span> <span class="nf">(obj) -&gt;</span>
                <span class="nx">obj</span><span class="p">.</span><span class="nx">_embedLocation</span><span class="p">()</span>
            <span class="s2">&quot;/api/embed/coll/#{ root.getServerType() }/#{ root.id }/#{ locations.join(&#39;/&#39;) }&quot;</span>
          <span class="k">else</span>
            <span class="s2">&quot;/api/root/#{ @model.getServerType() }&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h2>Setup Underscore templates for trivial templating</h2>

<p>Use Handlebars.clj for more complex variants</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_.templateSettings =</span>
        <span class="nv">interpolate: </span><span class="sr">/\{\{(.+?)\}\}/g</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h2>Return the map of useful classes</h2>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Model: </span><span class="nx">Model</span>
    <span class="nv">Collection: </span><span class="nx">Collection</span>
    <span class="nv">ReferenceCache: </span><span class="nx">ReferenceCache</span>
    <span class="nv">templateLoader: </span><span class="k">new</span> <span class="nx">TemplateLoader</span><span class="p">(</span><span class="s1">&#39;/api/templates/{{ id }}&#39;</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 